<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fractal Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        .noselect { -webkit-user-select: none; user-select: none; }
        canvas { display: block; }
        /* Scrollbar customization for the UI panel */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body class="text-white font-sans antialiased noselect">
    <!-- PixiJS Container -->
    <div id="canvas-container" class="absolute inset-0 z-0"></div>

    <!-- Export Frame Overlay (Hidden by default) -->
    <div id="export-frame" class="absolute hidden border-2 border-dashed border-yellow-400 pointer-events-none z-50 shadow-[0_0_15px_rgba(255,255,0,0.5)]">
        <div class="absolute top-2 left-2 bg-yellow-400 text-black text-[10px] font-bold px-1 rounded opacity-80">EXPORT AREA (16:9)</div>
    </div>

    <!-- UI Container -->
    <div id="ui-container" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 flex flex-col justify-between p-4">

        <!-- Header / Top Bar -->
        <div class="flex justify-between items-start pointer-events-auto">
            <div class="bg-black/60 backdrop-blur-md rounded-lg p-3 border border-white/10 shadow-lg">
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Fractal Explorer</h1>
                <p class="text-xs text-gray-400">Navigate the infinite</p>
            </div>

            <div class="flex gap-2">
                <button id="btn-save-fav" class="bg-black/60 backdrop-blur-md hover:bg-white/10 p-2 rounded-lg border border-white/10 transition" title="Save Favorite">
                    <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                </button>
                <button id="btn-favorites" class="bg-black/60 backdrop-blur-md hover:bg-white/10 p-2 rounded-lg border border-white/10 transition" title="View Favorites">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </button>
                <button id="btn-reset" class="bg-black/60 backdrop-blur-md hover:bg-white/10 p-2 rounded-lg border border-white/10 transition" title="Reset View">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357-2m0 0H15"></path></svg>
                </button>
            </div>
        </div>

        <!-- Sidebar Control Panel -->
        <div id="controls-panel" class="pointer-events-auto bg-black/60 backdrop-blur-md border border-white/10 rounded-lg p-4 w-full max-w-sm mt-4 ml-auto sm:ml-0 overflow-y-auto max-h-[70vh] shadow-2xl transition-transform duration-300">
            <div class="space-y-4">

                <!-- Fractal Selector -->
                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Fractal Type</label>
                    <select id="select-fractal" class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 transition">
                        <option value="mandelbrot">Mandelbrot Set</option>
                        <option value="julia">Julia Set</option>
                        <option value="newton">Newton Fractal</option>
                        <option value="barnsley">Barnsley Fern</option>
                    </select>
                </div>

                <!-- Parameters -->
                <div class="space-y-3">
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">Parameters</label>

                    <div>
                        <div class="flex justify-between text-xs text-gray-300 mb-1">
                            <span>Zoom</span>
                            <span id="val-zoom">1.0</span>
                        </div>
                        <input type="range" id="input-zoom" min="0.1" max="10000" step="0.1" class="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div>
                        <div class="flex justify-between text-xs text-gray-300 mb-1">
                            <span>Iterations / Detail</span>
                            <span id="val-iter">100</span>
                        </div>
                        <input type="range" id="input-iter" min="10" max="5000" step="10" value="100" class="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <!-- Colors -->
                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Color Palette</label>
                    <div class="flex gap-2">
                        <button class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 ring-2 ring-white/50 hover:scale-110 transition" onclick="app.setPalette('default')"></button>
                        <button class="w-6 h-6 rounded-full bg-gradient-to-br from-red-500 to-yellow-500 ring-1 ring-white/20 hover:scale-110 transition" onclick="app.setPalette('fire')"></button>
                        <button class="w-6 h-6 rounded-full bg-gradient-to-br from-green-400 to-teal-600 ring-1 ring-white/20 hover:scale-110 transition" onclick="app.setPalette('forest')"></button>
                        <button class="w-6 h-6 rounded-full bg-gradient-to-br from-gray-200 to-gray-800 ring-1 ring-white/20 hover:scale-110 transition" onclick="app.setPalette('bw')"></button>
                        <button class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-700 to-cyan-400 ring-1 ring-white/20 hover:scale-110 transition" onclick="app.setPalette('ocean')"></button>
                        <button class="w-6 h-6 rounded-full bg-gradient-to-br from-pink-500 to-cyan-500 ring-1 ring-white/20 hover:scale-110 transition" onclick="app.setPalette('neon')"></button>
                        <button class="w-6 h-6 rounded-full bg-gradient-to-br from-purple-800 to-orange-400 ring-1 ring-white/20 hover:scale-110 transition" onclick="app.setPalette('sunset')"></button>
                    </div>
                </div>

                <!-- Julia Specific -->
                <div id="julia-controls" class="hidden space-y-2 border-t border-white/10 pt-2">
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">Julia Constant (c)</label>
                    <div class="flex gap-2">
                         <div class="flex-1">
                            <span class="text-[10px] text-gray-400">Re</span>
                            <input type="range" id="input-julia-re" min="-2" max="2" step="0.001" class="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer">
                         </div>
                         <div class="flex-1">
                            <span class="text-[10px] text-gray-400">Im</span>
                            <input type="range" id="input-julia-im" min="-2" max="2" step="0.001" class="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer">
                         </div>
                    </div>
                </div>

                <!-- Export Controls -->
                <div class="border-t border-white/10 pt-2 space-y-2">
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">Export</label>
                    <div class="flex items-center gap-2">
                         <input type="checkbox" id="check-export-frame" class="w-4 h-4 bg-white/20 rounded border-none">
                         <span class="text-xs text-gray-300">Show Export Frame (16:9)</span>
                    </div>
                    <button id="btn-export-highres" class="w-full bg-blue-600/80 hover:bg-blue-600 text-white text-xs font-bold py-2 px-4 rounded transition">
                        Export High-Res (4K)
                    </button>
                </div>

                <div class="text-[10px] text-gray-500 pt-2">
                    Drag/Arrows to Pan • Scroll/Pinch to Zoom
                </div>
            </div>
        </div>

        <!-- Favorites Panel (Hidden by default) -->
        <div id="favorites-panel" class="pointer-events-auto absolute top-16 right-4 w-64 bg-black/80 backdrop-blur-md border border-white/10 rounded-lg shadow-xl hidden flex-col max-h-[80vh]">
            <div class="p-3 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-sm font-bold">Favorites</h3>
                <button id="btn-close-fav" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="favorites-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Favorites Items will be injected here -->
                <div class="text-center text-xs text-gray-500 py-4">No favorites yet</div>
            </div>
        </div>

    </div>

    <script>
        // --- Shaders ---

        const vertexShader = `
            attribute vec2 aVertexPosition;
            attribute vec2 aTextureCoord;

            uniform mat3 projectionMatrix;

            varying vec2 vTextureCoord;

            void main(void) {
                gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);
                vTextureCoord = aTextureCoord;
            }
        `;

        // Common utility functions for shaders
        const shaderUtils = `
            vec3 hsv2rgb(vec3 c) {
                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
            }

            vec3 getPaletteColor(float t, int paletteId) {
                if (paletteId == 1) { // Fire
                    return vec3(t, t*0.5, 0.0);
                } else if (paletteId == 2) { // Forest
                    return vec3(0.0, t, t*0.5);
                } else if (paletteId == 3) { // BW
                    return vec3(t);
                } else if (paletteId == 4) { // Ocean
                    return mix(vec3(0.0, 0.0, 0.2), vec3(0.0, 0.8, 1.0), t);
                } else if (paletteId == 5) { // Neon
                    return mix(vec3(1.0, 0.0, 1.0), vec3(0.0, 1.0, 1.0), t);
                } else if (paletteId == 6) { // Sunset
                    return mix(vec3(0.2, 0.1, 0.0), vec3(1.0, 0.5, 0.0), t);
                }
                // Default (Rainbow/Blue-Purple)
                return hsv2rgb(vec3(0.6 + 0.4*t, 1.0, t));
            }
        `;

        // Shader Code Definitions - Loops increased to 5000
        const mandelbrotFrag = `
            precision mediump float;
            varying vec2 vTextureCoord;
            uniform vec2 uResolution;
            uniform vec2 uCenter;
            uniform float uZoom;
            uniform int uMaxIter;
            uniform int uPalette;

            ` + shaderUtils + `

            void main() {
                vec2 uv = (gl_FragCoord.xy - uResolution.xy * 0.5) / min(uResolution.x, uResolution.y);
                vec2 c = uCenter + uv * (3.0 / uZoom);

                vec2 z = vec2(0.0);
                int iter = 0;

                for (int i = 0; i < 5000; i++) {
                    if (i >= uMaxIter) break;
                    float x = (z.x * z.x - z.y * z.y) + c.x;
                    float y = (z.y * z.x + z.x * z.y) + c.y;
                    if ((x * x + y * y) > 4.0) break;
                    z.x = x; z.y = y;
                    iter++;
                }

                if (iter == uMaxIter) {
                    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
                } else {
                    float t = float(iter) / float(uMaxIter);
                    t = sqrt(t);
                    vec3 col = getPaletteColor(t, uPalette);
                    gl_FragColor = vec4(col, 1.0);
                }
            }
        `;

        const juliaFrag = `
            precision mediump float;
            varying vec2 vTextureCoord;
            uniform vec2 uResolution;
            uniform vec2 uCenter;
            uniform float uZoom;
            uniform int uMaxIter;
            uniform int uPalette;
            uniform vec2 uJuliaC; // Custom C for Julia

            ` + shaderUtils + `

            void main() {
                vec2 uv = (gl_FragCoord.xy - uResolution.xy * 0.5) / min(uResolution.x, uResolution.y);
                vec2 z = uCenter + uv * (3.0 / uZoom);
                vec2 c = uJuliaC;

                int iter = 0;

                for (int i = 0; i < 5000; i++) {
                    if (i >= uMaxIter) break;
                    float x = (z.x * z.x - z.y * z.y) + c.x;
                    float y = (z.y * z.x + z.x * z.y) + c.y;
                    if ((x * x + y * y) > 4.0) break;
                    z.x = x; z.y = y;
                    iter++;
                }

                if (iter == uMaxIter) {
                    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
                } else {
                    float t = float(iter) / float(uMaxIter);
                    t = sqrt(t);
                    vec3 col = getPaletteColor(t, uPalette);
                    gl_FragColor = vec4(col, 1.0);
                }
            }
        `;

        const newtonFrag = `
            precision mediump float;
            varying vec2 vTextureCoord;
            uniform vec2 uResolution;
            uniform vec2 uCenter;
            uniform float uZoom;
            uniform int uMaxIter;
            uniform int uPalette;

            ` + shaderUtils + `

            // Complex multiplication
            vec2 cmul(vec2 a, vec2 b) {
                return vec2(a.x*b.x - a.y*b.y, a.x*b.y + a.y*b.x);
            }

            // Complex division
            vec2 cdiv(vec2 a, vec2 b) {
                float denom = b.x*b.x + b.y*b.y;
                return vec2((a.x*b.x + a.y*b.y)/denom, (a.y*b.x - a.x*b.y)/denom);
            }

            void main() {
                vec2 uv = (gl_FragCoord.xy - uResolution.xy * 0.5) / min(uResolution.x, uResolution.y);
                vec2 z = uCenter + uv * (3.0 / uZoom);

                int iter = 0;
                vec2 roots[3];
                roots[0] = vec2(1.0, 0.0);
                roots[1] = vec2(-0.5, 0.866025);
                roots[2] = vec2(-0.5, -0.866025);

                float minDist = 100.0;
                int rootIdx = -1;

                for (int i = 0; i < 5000; i++) {
                    if (i >= uMaxIter) break;

                    vec2 z2 = cmul(z, z);
                    vec2 z3 = cmul(z2, z);
                    // Numerator: z^3 - 1
                    vec2 num = z3 - vec2(1.0, 0.0);
                    // Denom: 3z^2
                    vec2 den = 3.0 * z2;

                    if (length(den) < 0.0001) break;

                    z = z - cdiv(num, den);

                    for (int r = 0; r < 3; r++) {
                        float d = distance(z, roots[r]);
                        if (d < 0.001) {
                            rootIdx = r;
                            iter = i;
                            break;
                        }
                    }
                    if (rootIdx != -1) break;
                }

                if (rootIdx != -1) {
                    float t = float(iter) / 50.0;
                    vec3 baseCol;
                    if (rootIdx == 0) baseCol = vec3(1.0, 0.2, 0.2);
                    else if (rootIdx == 1) baseCol = vec3(0.2, 1.0, 0.2);
                    else baseCol = vec3(0.2, 0.2, 1.0);

                    gl_FragColor = vec4(baseCol * (1.0 - t), 1.0);
                } else {
                    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
                }
            }
        `;

        // --- Application Class ---

        class FractalApp {
            constructor() {
                this.app = new PIXI.Application({
                    resizeTo: window,
                    backgroundColor: 0x000000,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true,
                    powerPreference: "high-performance"
                });

                document.getElementById('canvas-container').appendChild(this.app.view);

                // Default state
                this.defaultState = {
                    fractal: 'mandelbrot',
                    zoom: 1.0,
                    center: { x: -0.5, y: 0.0 },
                    iterations: 100,
                    palette: 0,
                    juliaC: { x: -0.7, y: 0.27015 },
                    favorites: []
                };

                this.state = JSON.parse(JSON.stringify(this.defaultState));
                this.showExportFrame = false;

                // Filter container
                this.fractalContainer = new PIXI.Container();
                this.fractalSprite = new PIXI.Sprite(PIXI.Texture.WHITE);
                this.fractalSprite.width = this.app.screen.width;
                this.fractalSprite.height = this.app.screen.height;
                this.fractalContainer.addChild(this.fractalSprite);
                this.app.stage.addChild(this.fractalContainer);

                // Shader Uniforms
                this.uniforms = {
                    uResolution: [this.app.screen.width, this.app.screen.height],
                    uCenter: [this.state.center.x, this.state.center.y],
                    uZoom: this.state.zoom,
                    uMaxIter: this.state.iterations,
                    uPalette: this.state.palette
                };

                // Initialize Shaders
                this.mandelbrotFilter = new PIXI.Filter(vertexShader, mandelbrotFrag, this.uniforms);
                this.juliaFilter = new PIXI.Filter(vertexShader, juliaFrag, { ...this.uniforms, uJuliaC: [this.state.juliaC.x, this.state.juliaC.y] });
                this.newtonFilter = new PIXI.Filter(vertexShader, newtonFrag, this.uniforms);

                // Barnsley Fern Container
                this.barnsleyContainer = new PIXI.Container();
                this.barnsleyGraphics = new PIXI.Graphics();
                this.barnsleyContainer.addChild(this.barnsleyGraphics);
                this.barnsleyContainer.visible = false;
                this.app.stage.addChild(this.barnsleyContainer);

                // Apply initial shader
                this.updateShader();
                this.updateUniforms();

                // Bind events
                this.bindEvents();

                // Resize handler
                this.app.renderer.on('resize', () => {
                    this.fractalSprite.width = this.app.screen.width;
                    this.fractalSprite.height = this.app.screen.height;
                    this.uniforms.uResolution = [this.app.screen.width, this.app.screen.height];
                    this.updateExportFrame();
                });
            }

            resetView() {
                // Keep favorites, reset other view params
                const favs = this.state.favorites;
                this.state = JSON.parse(JSON.stringify(this.defaultState));
                this.state.favorites = favs;

                // Update UI
                document.getElementById('select-fractal').value = this.state.fractal;
                document.getElementById('input-zoom').value = 1.0;
                document.getElementById('val-zoom').innerText = "1.00";
                document.getElementById('input-iter').value = this.state.iterations;
                document.getElementById('val-iter').innerText = this.state.iterations;
                document.getElementById('input-julia-re').value = this.state.juliaC.x;
                document.getElementById('input-julia-im').value = this.state.juliaC.y;
                document.getElementById('julia-controls').classList.add('hidden');

                this.updateShader();
                this.updateUniforms();
                this.saveSettings();
            }

            updateShader() {
                this.fractalContainer.visible = true;
                this.barnsleyContainer.visible = false;
                this.fractalContainer.filters = [];

                if (this.state.fractal === 'mandelbrot') {
                    this.fractalContainer.filters = [this.mandelbrotFilter];
                } else if (this.state.fractal === 'julia') {
                    this.fractalContainer.filters = [this.juliaFilter];
                } else if (this.state.fractal === 'newton') {
                    this.fractalContainer.filters = [this.newtonFilter];
                } else if (this.state.fractal === 'barnsley') {
                    this.fractalContainer.visible = false;
                    this.barnsleyContainer.visible = true;
                    this.renderBarnsley();
                }
            }

            updateUniforms() {
                this.uniforms.uCenter = [this.state.center.x, this.state.center.y];
                this.uniforms.uZoom = this.state.zoom;
                this.uniforms.uMaxIter = this.state.iterations;
                this.uniforms.uPalette = this.state.palette;

                this.mandelbrotFilter.uniforms.uCenter = this.uniforms.uCenter;
                this.mandelbrotFilter.uniforms.uZoom = this.uniforms.uZoom;
                this.mandelbrotFilter.uniforms.uMaxIter = this.uniforms.uMaxIter;
                this.mandelbrotFilter.uniforms.uPalette = this.uniforms.uPalette;

                this.juliaFilter.uniforms.uCenter = this.uniforms.uCenter;
                this.juliaFilter.uniforms.uZoom = this.uniforms.uZoom;
                this.juliaFilter.uniforms.uMaxIter = this.uniforms.uMaxIter;
                this.juliaFilter.uniforms.uPalette = this.uniforms.uPalette;
                this.juliaFilter.uniforms.uJuliaC = [this.state.juliaC.x, this.state.juliaC.y];

                this.newtonFilter.uniforms.uCenter = this.uniforms.uCenter;
                this.newtonFilter.uniforms.uZoom = this.uniforms.uZoom;
                this.newtonFilter.uniforms.uMaxIter = this.uniforms.uMaxIter;
                this.newtonFilter.uniforms.uPalette = this.uniforms.uPalette;

                if (this.state.fractal === 'barnsley') {
                    const w = this.app.screen.width;
                    const h = this.app.screen.height;
                    const minDim = Math.min(w, h);
                    const zoomScale = this.state.zoom * (minDim / 10.0);
                    this.barnsleyContainer.position.set(w / 2, h / 2);
                    this.barnsleyContainer.scale.set(zoomScale, -zoomScale);
                    this.barnsleyContainer.pivot.set(this.state.center.x, this.state.center.y + 5.0);

                    if (this.lastBarnsleyIter !== this.state.iterations) {
                        this.renderBarnsley();
                    }
                }
            }

            renderBarnsley() {
                this.lastBarnsleyIter = this.state.iterations;
                const g = this.barnsleyGraphics;
                g.clear();
                g.beginFill(0x00FF00, 0.5);
                const iterations = this.state.iterations * 200;
                let x = 0; let y = 0;
                for (let i = 0; i < iterations; i++) {
                    let nextX, nextY;
                    let r = Math.random();
                    if (r < 0.01) { nextX = 0; nextY = 0.16 * y; }
                    else if (r < 0.86) { nextX = 0.85 * x + 0.04 * y; nextY = -0.04 * x + 0.85 * y + 1.6; }
                    else if (r < 0.93) { nextX = 0.2 * x - 0.26 * y; nextY = 0.23 * x + 0.22 * y + 1.6; }
                    else { nextX = -0.15 * x + 0.28 * y; nextY = 0.26 * x + 0.24 * y + 0.44; }
                    x = nextX; y = nextY;
                    if (i > 20) g.drawRect(x, y, 0.01, 0.01);
                }
                g.endFill();
            }

            getScaleFactor() {
                // Returns world unit span for zooming/panning calculations
                // Shaders (Mandelbrot, Julia, Newton) use ~3.0
                // Barnsley uses ~10.0 (roughly -2.5 to 2.5 x, 0 to 10 y)
                if (this.state.fractal === 'barnsley') return 10.0;
                return 3.0;
            }

            updateExportFrame() {
                const frame = document.getElementById('export-frame');
                if (!this.showExportFrame) {
                    frame.classList.add('hidden');
                    return;
                }

                // We want 16:9 box centered
                const sw = this.app.screen.width;
                const sh = this.app.screen.height;
                const aspect = 16/9;

                let w = sw * 0.9;
                let h = w / aspect;

                if (h > sh * 0.9) {
                    h = sh * 0.9;
                    w = h * aspect;
                }

                frame.style.width = `${w}px`;
                frame.style.height = `${h}px`;
                frame.style.left = `${(sw - w)/2}px`;
                frame.style.top = `${(sh - h)/2}px`;

                frame.classList.remove('hidden');
            }

            bindEvents() {
                // Mouse Drag
                let isDragging = false;
                let lastPos = null;

                const onDown = (e) => {
                    isDragging = true;
                    lastPos = { x: e.global.x, y: e.global.y };
                };

                const onMove = (e) => {
                    if (!isDragging) return;
                    const newPos = { x: e.global.x, y: e.global.y };
                    const dx = newPos.x - lastPos.x;
                    const dy = newPos.y - lastPos.y;
                    const scale = this.getScaleFactor() / (this.state.zoom * Math.min(this.app.screen.width, this.app.screen.height));

                    this.state.center.x -= dx * scale;
                    this.state.center.y += dy * scale;
                    lastPos = newPos;
                    this.updateUniforms();
                };

                const onUp = () => { isDragging = false; lastPos = null; };

                // Cursor-Centered Zoom
                const onWheel = (e) => {
                    e.preventDefault();
                    const rect = this.app.view.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;
                    const w = this.app.screen.width;
                    const h = this.app.screen.height;
                    const minDim = Math.min(w, h);

                    // Current mouse pos in UV-normalized centered coords (Y inverted relative to screen)
                    // uv.x = (mx - w/2) / minDim
                    // uv.y = (h/2 - my) / minDim
                    const u = (mx - w * 0.5) / minDim;
                    const v = (h * 0.5 - my) / minDim;

                    const oldZoom = this.state.zoom;
                    const zoomFactor = 1.1;

                    if (e.deltaY < 0) {
                        this.state.zoom *= zoomFactor;
                    } else {
                        this.state.zoom /= zoomFactor;
                    }

                    // Adjust center to keep mouse world position stationary
                    // CenterNew = CenterOld + (UV) * (Scale/ZoomOld - Scale/ZoomNew)
                    const term = this.getScaleFactor() * (1.0/oldZoom - 1.0/this.state.zoom);
                    this.state.center.x += u * term;
                    this.state.center.y += v * term;

                    document.getElementById('input-zoom').value = this.state.zoom;
                    document.getElementById('val-zoom').innerText = this.state.zoom.toFixed(2);

                    this.updateUniforms();
                };

                // Keyboard Panning
                window.addEventListener('keydown', (e) => {
                    const minDim = Math.min(this.app.screen.width, this.app.screen.height);
                    const scale = this.getScaleFactor() / (this.state.zoom * minDim);
                    const stepPixels = 50; // Move 50 pixels worth
                    const moveStep = stepPixels * scale;

                    if (e.key === 'ArrowUp') this.state.center.y += moveStep;
                    else if (e.key === 'ArrowDown') this.state.center.y -= moveStep;
                    else if (e.key === 'ArrowLeft') this.state.center.x -= moveStep;
                    else if (e.key === 'ArrowRight') this.state.center.x += moveStep;
                    else return;

                    this.updateUniforms();
                });

                this.fractalSprite.eventMode = 'static';
                this.fractalSprite.on('pointerdown', onDown);
                this.fractalSprite.on('globalpointermove', onMove);
                this.fractalSprite.on('pointerup', onUp);
                this.fractalSprite.on('pointerupoutside', onUp);

                this.app.view.addEventListener('wheel', onWheel, { passive: false });

                // UI Controls
                document.getElementById('select-fractal').addEventListener('change', (e) => {
                    this.state.fractal = e.target.value;
                    if (this.state.fractal === 'julia') document.getElementById('julia-controls').classList.remove('hidden');
                    else document.getElementById('julia-controls').classList.add('hidden');
                    this.updateShader();
                    this.updateUniforms();
                });

                document.getElementById('input-zoom').addEventListener('input', (e) => {
                    this.state.zoom = parseFloat(e.target.value);
                    document.getElementById('val-zoom').innerText = this.state.zoom.toFixed(2);
                    this.updateUniforms();
                });

                document.getElementById('input-iter').addEventListener('input', (e) => {
                    this.state.iterations = parseInt(e.target.value);
                    document.getElementById('val-iter').innerText = this.state.iterations;
                    this.updateUniforms();
                });

                document.getElementById('input-julia-re').addEventListener('input', (e) => {
                    this.state.juliaC.x = parseFloat(e.target.value);
                    this.updateUniforms();
                });
                document.getElementById('input-julia-im').addEventListener('input', (e) => {
                    this.state.juliaC.y = parseFloat(e.target.value);
                    this.updateUniforms();
                });

                // Export Frame Toggle
                document.getElementById('check-export-frame').addEventListener('change', (e) => {
                    this.showExportFrame = e.target.checked;
                    this.updateExportFrame();
                });
            }

            setPalette(name) {
                const map = { 'default': 0, 'fire': 1, 'forest': 2, 'bw': 3, 'ocean': 4, 'neon': 5, 'sunset': 6 };
                this.state.palette = map[name] || 0;
                this.updateUniforms();
            }

            saveSettings() {
                localStorage.setItem('fractalSettings', JSON.stringify(this.state));
            }

            loadSettings() {
                const saved = localStorage.getItem('fractalSettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.state = { ...this.state, ...parsed };
                    document.getElementById('select-fractal').value = this.state.fractal;
                    document.getElementById('input-zoom').value = this.state.zoom;
                    document.getElementById('val-zoom').innerText = this.state.zoom.toFixed(2);
                    document.getElementById('input-iter').value = this.state.iterations;
                    document.getElementById('val-iter').innerText = this.state.iterations;
                    document.getElementById('input-julia-re').value = this.state.juliaC.x;
                    document.getElementById('input-julia-im').value = this.state.juliaC.y;
                    if (this.state.fractal === 'julia') document.getElementById('julia-controls').classList.remove('hidden');
                    this.updateShader();
                    this.updateUniforms();
                    this.renderFavoritesList();
                }
            }

            addFavorite() {
                const fav = {
                    id: Date.now(),
                    fractal: this.state.fractal,
                    zoom: this.state.zoom,
                    center: { ...this.state.center },
                    iterations: this.state.iterations,
                    palette: this.state.palette,
                    juliaC: { ...this.state.juliaC },
                    timestamp: new Date().toLocaleTimeString()
                };
                this.state.favorites.push(fav);
                this.saveSettings();
                this.renderFavoritesList();
                alert('Saved to favorites!');
            }

            loadFavorite(id) {
                const fav = this.state.favorites.find(f => f.id === id);
                if (fav) {
                    this.state.fractal = fav.fractal;
                    this.state.zoom = fav.zoom;
                    this.state.center = { ...fav.center };
                    this.state.iterations = fav.iterations;
                    this.state.palette = fav.palette;
                    this.state.juliaC = { ...fav.juliaC };

                    document.getElementById('select-fractal').value = fav.fractal;
                    document.getElementById('val-zoom').innerText = fav.zoom.toFixed(2);
                    document.getElementById('input-zoom').value = fav.zoom;
                    document.getElementById('input-iter').value = fav.iterations;
                    document.getElementById('val-iter').innerText = fav.iterations;
                    if (fav.fractal === 'julia') {
                         document.getElementById('julia-controls').classList.remove('hidden');
                         document.getElementById('input-julia-re').value = fav.juliaC.x;
                         document.getElementById('input-julia-im').value = fav.juliaC.y;
                    } else document.getElementById('julia-controls').classList.add('hidden');

                    this.updateShader();
                    this.updateUniforms();
                }
            }

            removeFavorite(id) {
                this.state.favorites = this.state.favorites.filter(f => f.id !== id);
                this.saveSettings();
                this.renderFavoritesList();
            }

            renderFavoritesList() {
                const list = document.getElementById('favorites-list');
                list.innerHTML = '';
                if (this.state.favorites.length === 0) {
                    list.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">No favorites yet</div>';
                    return;
                }
                this.state.favorites.forEach(fav => {
                    const el = document.createElement('div');
                    el.className = 'bg-white/10 p-2 rounded flex justify-between items-center';
                    el.innerHTML = `
                        <div class="cursor-pointer flex-1" onclick="window.fractalApp.loadFavorite(${fav.id})">
                            <div class="text-xs font-bold capitalize">${fav.fractal}</div>
                            <div class="text-[10px] text-gray-400">Zoom: ${fav.zoom.toFixed(1)} • ${fav.timestamp}</div>
                        </div>
                        <button onclick="window.fractalApp.removeFavorite(${fav.id})" class="text-red-400 hover:text-red-200 ml-2">&times;</button>
                    `;
                    list.appendChild(el);
                });
            }

            exportHighRes() {
                // Target: 4K (16:9)
                const targetW = 3840;
                const targetH = 2160;

                // If the export frame is shown, we want to match its content.
                // If not shown, we default to matching what is visible on screen as best as possible (fitting width or height).
                // Let's assume we always want to match what the 'Export Frame' WOULD show.

                // On Screen Logic:
                const sw = this.app.screen.width;
                const sh = this.app.screen.height;
                const sMin = Math.min(sw, sh);

                // Export Frame Overlay dimensions
                const aspect = 16/9;
                let frameW = sw * 0.9;
                let frameH = frameW / aspect;
                if (frameH > sh * 0.9) {
                    frameH = sh * 0.9;
                    frameW = frameH * aspect;
                }

                // Calculate Adjusted Zoom
                // World Height of Overlay = FrameH * (3.0 / (Zoom * sMin))
                // World Height of Target = 3.0 / ExportZoom  (since Target H is min dim for 16:9)
                // Equalize: FrameH / (Zoom * sMin) = 1 / ExportZoom
                // ExportZoom = (Zoom * sMin) / FrameH

                const exportZoom = (this.state.zoom * sMin) / frameH;

                // Prepare Render Texture
                const renderTexture = PIXI.RenderTexture.create({ width: targetW, height: targetH });

                // Setup specific filter for export
                const uniforms = {
                     uResolution: [targetW, targetH],
                     uCenter: [this.state.center.x, this.state.center.y],
                     uZoom: exportZoom,
                     uMaxIter: this.state.iterations,
                     uPalette: this.state.palette,
                     uJuliaC: [this.state.juliaC.x, this.state.juliaC.y]
                };

                let filter;
                if (this.state.fractal === 'mandelbrot') filter = new PIXI.Filter(vertexShader, mandelbrotFrag, uniforms);
                else if (this.state.fractal === 'julia') filter = new PIXI.Filter(vertexShader, juliaFrag, uniforms);
                else if (this.state.fractal === 'newton') filter = new PIXI.Filter(vertexShader, newtonFrag, uniforms);
                else {
                    // Barnsley not supported for high-res shader export easily in this pipeline without logic duplication
                    alert("High-res export not fully supported for Barnsley Fern yet.");
                    return;
                }

                const sprite = new PIXI.Sprite(PIXI.Texture.WHITE);
                sprite.width = targetW;
                sprite.height = targetH;
                sprite.filters = [filter];

                // Render
                this.app.renderer.render(sprite, { renderTexture });

                // Extract
                this.app.renderer.extract.canvas(renderTexture).toBlob((blob) => {
                    const a = document.createElement('a');
                    document.body.append(a);
                    a.download = `fractal_4k_${Date.now()}.png`;
                    a.href = URL.createObjectURL(blob);
                    a.click();
                    a.remove();

                    // Cleanup
                    renderTexture.destroy(true);
                    sprite.destroy();
                }, 'image/png');
            }
        }

        const app = new FractalApp();
        window.fractalApp = app;

        try { app.loadSettings(); } catch (e) { console.error(e); }

        document.getElementById('btn-save-fav').addEventListener('click', () => app.addFavorite());
        document.getElementById('btn-favorites').addEventListener('click', () => {
             const panel = document.getElementById('favorites-panel');
             if (panel.classList.contains('hidden')) {
                 panel.classList.remove('hidden');
                 panel.classList.add('flex');
                 app.renderFavoritesList();
             } else {
                 panel.classList.add('hidden');
                 panel.classList.remove('flex');
             }
        });
        document.getElementById('btn-close-fav').addEventListener('click', () => {
             const panel = document.getElementById('favorites-panel');
             panel.classList.add('hidden');
             panel.classList.remove('flex');
        });

        document.getElementById('btn-export-highres').addEventListener('click', () => app.exportHighRes());
        document.getElementById('btn-reset').addEventListener('click', () => app.resetView());

        // Removed old btn-export in favor of highres, or keeping it?
        // HTML has btn-export but I didn't update the binding in the new script block?
        // Wait, the HTML I wrote above removed `btn-export` and added `btn-reset` in the top bar?
        // No, `btn-export` is gone from top bar in my HTML above?
        // Let's check the HTML string.
        // The top bar has: btn-save-fav, btn-favorites, btn-reset.
        // The export is now in the sidebar under "Export".

        window.addEventListener('beforeunload', () => app.saveSettings());

    </script>
</body>
</html>
